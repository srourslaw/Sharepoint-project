# Security Configuration for NGINX
# SharePoint AI Dashboard

# Security headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), fullscreen=(self), payment=()" always;

# Content Security Policy
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'self' https://graph.microsoft.com https://login.microsoftonline.com https://api.openai.com https://*.openai.azure.com;
    frame-src 'self' https://login.microsoftonline.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    upgrade-insecure-requests;
" always;

# HSTS (HTTP Strict Transport Security)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Hide server information
server_tokens off;
more_clear_headers Server;
more_set_headers "Server: SharePoint-AI-Dashboard";

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=upload:10m rate=2r/s;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=addr:10m;

# Request size limits
client_max_body_size 100m;
client_header_buffer_size 1k;
large_client_header_buffers 4 4k;

# Timeout settings
client_body_timeout 12;
client_header_timeout 12;
keepalive_timeout 15;
send_timeout 10;

# Buffer settings for security
client_body_buffer_size 128k;
client_header_buffer_size 1k;

# Disable unused HTTP methods
location / {
    limit_except GET POST PUT PATCH DELETE OPTIONS {
        deny all;
    }
}

# Block common attack patterns
location ~* \.(php|jsp|cgi|asp|aspx)$ {
    deny all;
}

# Block access to sensitive files
location ~* /\.(htaccess|htpasswd|svn|git|env) {
    deny all;
}

# Block access to backup files
location ~* \.(bak|backup|old|tmp|temp|swp|swo|log)$ {
    deny all;
}

# Block SQL injection attempts
location ~* (union|select|insert|delete|update|concat|database|table|from|where) {
    deny all;
}

# Block XSS attempts
location ~* (<|%3c)(script|iframe|object|embed|applet) {
    deny all;
}

# Block directory traversal attempts
location ~* \.\./\.\. {
    deny all;
}

# Block user agent scanning
location ~* (nmap|masscan|zmap) {
    deny all;
}

# Security for API endpoints
location /api/ {
    limit_req zone=api burst=50 nodelay;
    limit_conn addr 20;
    
    # Additional API security headers
    add_header X-API-Version "1.0" always;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    
    # Block suspicious patterns in API calls
    if ($request_uri ~* "(eval\(|javascript:|vbscript:|onload|onerror)" ) {
        return 403;
    }
}

# Security for authentication endpoints
location /api/auth/ {
    limit_req zone=auth burst=10 nodelay;
    limit_conn addr 5;
    
    # Enhanced logging for auth attempts
    access_log /var/log/nginx/auth_access.log combined;
    
    # Block brute force attempts
    if ($http_user_agent ~* (curl|wget|python|java|go-http)) {
        return 403;
    }
}

# Security for file upload endpoints
location /api/upload/ {
    limit_req zone=upload burst=5 nodelay;
    limit_conn addr 3;
    
    # File upload restrictions
    client_max_body_size 100m;
    client_body_timeout 300s;
    
    # Block executable file uploads
    if ($request_filename ~* \.(exe|bat|sh|com|scr|pif|cmd)$) {
        return 403;
    }
}

# Prevent access to internal services
location /internal/ {
    deny all;
}

# Block access to metrics endpoint from external
location /metrics {
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
}

# Security logging
error_log /var/log/nginx/security_error.log warn;

# Log format for security analysis
log_format security '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '$request_time $upstream_response_time '
                   '"$http_x_forwarded_for" "$http_x_real_ip"';

access_log /var/log/nginx/security_access.log security;